
# ML System Design Doc - Система поддержки управления электровозом (MVP)

## 1. Цели и предпосылки

### 1.1. Зачем идем в разработку продукта?

- **Бизнес-цель:** Повысить безопасность и экономическую эффективность железнодорожных перевозок за счет автоматического контроля скоростного режима электровоза с использованием компьютерного зрения.
- **Почему станет лучше:** Система позволит точнее определять координаты поезда, избегать ошибок расчета километража, сократить нагрузки на тормозные системы и уменьшить аварийность.
- **Что будем считать успехом итерации:**  
  Система успешно выявляет расхождения между фактической и расчетной координатами поезда **и обнаруживает препятствия на пути** с точностью 98%+ при тестировании.

### 1.2. Бизнес-требования и ограничения

- **Бизнес-требования:**  
  - Определение координаты поезда в реальном времени на основе анализа километровых и пикетных столбиков.  
  - **Обнаружение препятствий на пути ЖД состава в режиме реального времени.**
  - Автоматическое предупреждение машиниста в случае расхождения данных или обнаружения препятствия.
- **Бизнес-ограничения:**  
  - Работа в автономном режиме без стабильного подключения к внешним системам связи.
  - Минимизация затрат на внедрение и эксплуатацию.
- **Ожидания от итерации:**  
  - Прототип, интегрированный с системами УСАВП.
- **Бизнес-процесс пилота:**  
  - Интеграция системы в процессы управления локомотивом; пилотное тестирование на реальных маршрутах.
- **Что считаем успешным пилотом:**  
  - Точность распознавания объектов ≥ 98%,  
  - Снижение количества аварийных ситуаций, связанных с неправильным расчетом координат.

### 1.3. Что входит в скоуп проекта/итерации, что не входит

- **Входит в скоуп:**  
  - Распознавание километровых и пикетных столбиков.
  - Сравнение с данными УСАВП и вывод предупреждений.
  - **Обнаружение препятствий на железной дороге (животные, машины, посторонние предметы).**
- **Не входит в скоуп:**  
  - Управление движением поезда (система только предупреждает машиниста).
- **Качество кода:**  
  - Асинхронное API на FastAPI с использованием SQLAlchemy для работы с базой данных.
- **Технический долг:**  
  - Оптимизация скорости обработки изображений.

### 1.4. Предпосылки решения

- Использование технологий CV и OCR для обработки видеопотока с камеры.
- Система работает локально.
- Использование базы данных PostgreSQL и мониторинга через Grafana.

## 2. Методология

### 2.1. Постановка задачи

- **Техническая задача:**  
  Обнаружение километровых и пикетных столбиков на изображениях, распознавание координат, **обнаружение препятствий на пути поезда** для контроля скоростного режима и предотвращения ЧС.

### 2.2. Блок-схема решения

Верхнеуровневая рхитектура

```mermaid
---
title: ML architecture flowchart - Система поддержки управления электровозом
---

flowchart TD
    camera[fa:fa-video Camera stream]
    detection_model((CV - Обнаружение объектов))
    
    subgraph Обработка объектов
        detect_obstacle{{Obstacle detected?}}
        detect_post{{Post detected?}}
    end

    ocr_model((OCR - Распознавание текста))
    usavp_data[(USAVP Data - координаты УСАВП)]
    analysis((Аналитика координат))
    
    alert_obstacle{{ALERT: Obstacle warning}}
    alert_mismatch{{WARNING: Coordinate mismatch}}

    monitoring[(PostgreSQL + Grafana - Monitoring & Logs)]

    camera --> detection_model
    detection_model --> detect_obstacle
    detection_model --> detect_post

    detect_obstacle -- Yes --> alert_obstacle
    alert_obstacle --> monitoring

    detect_post -- Yes --> ocr_model
    ocr_model --> analysis
    usavp_data --> analysis

    analysis --Mismatch--> alert_mismatch
    alert_mismatch --> monitoring

```

### 2.3. Этапы решения задачи

#### Этап 1. Подготовка данных

Исходные данные были получены из видеопотока, снятого с камеры, установленной в кабине локомотива. Из видео извлекались ключевые кадры, на которых присутствуют железнодорожные километровые и пикетные столбики.

##### Структура данных

- **YOLO-аннотации**: к каждому изображению прикреплён `.txt`-файл с нормализованными координатами bounding box и class_id.
- **OCR-фрагменты**: вырезки участков изображений с цифрами на табличках столбиков. Имена файлов содержат метку (например, `crop_1006.png` → "1006").

##### Выявленные проблемы (EDA)

- **Дисбаланс классов**: километровые столбики сильно преобладают над пикетными.
- **Повторяющиеся и почти идентичные кадры**: присутствуют последовательные фреймы из одного участка.
- **OCR**: неполный охват цифр (например, цифры 3, 4, 5, 9 отсутствуют).
- **Низкое разрешение OCR-фрагментов**, частично размытые или контрастные.

##### Решения

- Использование аугментаций (яркость, шум, вращение, обрезка).
- Балансировка классов путём доразметки и отбора дополнительных кадров.
- Суперразрешение (super-resolution) и предобработка вырезок для OCR.
- Удаление дубликатов и однотипных изображений.

##### Конфиденциальность

Персональные данные отсутствуют. Изображения содержат только железнодорожную инфраструктуру.

#### Цель этапа

Получение чистого, разнообразного, сбалансированного датасета из размеченных изображений и OCR-фрагментов для устойчивого обучения моделей.

---

#### Этап 2. Подготовка прогнозных моделей

##### Метрики

- **YOLO**: mAP@0.5, Precision, Recall по каждому классу.
- **OCR**: Accuracy посимвольно и построчно (совпадение всей строки).

##### Функции потерь

- **YOLO**: BCE + CIoU (объединённая функция для класса и локализации).
- **OCR**: CTC Loss или CrossEntropy в зависимости от архитектуры.

##### Валидация

- Разделение на train/test стратифицировано по классам.
- Исключение смежных кадров из разных частей видео.
- Учет разнообразия сцен (погода, освещение, дальность до объекта).

##### Бейзлайны

- **YOLO без дообучения** — низкое качество на столбиках.
- **EasyOCR без настройки** — частые ошибки на коротких, мелких цифрах.

##### Развитие

- Fine-tuning YOLO на собственных аннотациях.
- Дообучение EasyOCR или замена на легковесную OCR-модель.
- Аугментации + super-resolution.
- Автофильтрация слабых/ложных предсказаний.

##### Риски

- Переобучение на одинаковых кадрах.
- Сложности с распознаванием цифр малого размера.
- Слабое обобщение на редкие классы и символы.

##### Результат

Работающие модели детекции и OCR, обеспечивающие стабильное распознавание координатных меток на видеоизображениях.

---

#### Этап 3. Обработка видеопотока

Система обрабатывает видеопоток в реальном времени.

##### Конвейер

1. Захват кадра (RTSP или видеофайл).
2. Обнаружение объектов (YOLO).
3. Вырезка фрагментов.
4. Распознавание цифр (OCR).
5. Комбинация километра и пикета.
6. Сопоставление с данными УСАВП.
7. Логирование результатов.

##### Оптимизация

- Использование облегчённой YOLO.
- TensorRT/ONNX ускорение на Jetson Nano.
- Многопоточность: видео, детекция и OCR обрабатываются асинхронно.
- Регулируемая частота кадров.

##### Назначение

Сопоставление координаты по CV с официальными данными движения (УСАВП), а также формирование журналов несоответствий для анализа.

## 3. Подготовка пилота

### 3.1. Способ оценки пилота

- Сбор данных о срабатывании системы предупреждения.
- Сравнение с реальными координатами поезда.

### 3.2. Что считаем успешным пилотом

- Количество ошибок обнаружения < 2% на тестовом маршруте.
- Среднее время реакции системы < 1 секунда.
- 100% обнаружение всех препятствий на пути на тестовых маршрутах.

### 3.3. Подготовка пилота

- Тестирование на видеозаписях с реальных электровозов.

## 4. Внедрение

### 4.1. Архитектура решения

- Камера → CV → OCR → FastAPI → PostgreSQL → Grafana.
**будет дополнено в будущем**
  
### 4.2. Инфраструктура и масштабируемость

- Платформа: **будет рассчитана позже**.
- База данных: PostgreSQL.
- Мониторинг: Grafana.

### 4.3. Требования к работе системы

- Время обработки одного кадра: до 100 мс.
- Точность распознавания символов: > 90%.

### 4.4. Безопасность системы

- Автономная работа без передачи данных в облако.

### 4.5. Безопасность данных

- Данные обрабатываются локально;
  
### 4.6. Издержки

- Оценочные затраты: 300-500$ на устройство и 100$ в месяц на поддержку.

### 4.7. Integration points

- FastAPI эндпоинты для загрузки и получения данных о поездках.

### 4.8. Риски

- Ошибки распознавания при плохой погоде.
- Повреждение столбиков, плохая видимость знаков.
- Ложные срабатывания при обнаружении препятствий.
